<% filters = @taxon ? @taxon.applicable_filters : [Spree::Core::ProductFilters.all_taxons] %>
<% unless filters.empty? %>
    <%= form_tag '', method: :get, id: 'sidebar_products_search' do %>
      <%= hidden_field_tag 'per_page', params[:per_page] %>
      <div class="filters">
      <% filters.each do |filter| %>
        <% labels = filter[:labels] || filter[:conds].map {|m,c| [m,m]} %>
        <% next if labels.empty? %>
        <div class="item">
          <div class="title"><%= filter[:name] %></div>
          <%= '<div class="formats_wrapper">'.html_safe if filter[:type] == 'formats' %>
          <div class="<%= filter[:type] %>">
            <% labels.each do |nm,val| %>
              <% label = "#{filter[:name]}_#{nm}".gsub(/\s+/,'_') %>
              <div class="item">
                <input
                  type="checkbox"
                  id="<%= label %>"
                  name="search[<%= filter[:scope].to_s %>][]"
                  value="<%= val %>"
                  <%= params[:search].present? && params[:search][filter[:scope]] && params[:search][filter[:scope]].include?(val.to_s) ? "checked" : "" %>
                  onclick="javascript: this.form.submit();"
                  />
                <label
                  style="background: url(<%= asset_url filter[:images][val.to_sym] unless filter[:type] == 'formats'%>) center"
                  for="<%= label %>"
                  data-toggle="popover"
                  data-content="&lt;span&gt;<%= val %>&lt;/span&gt;"
                >
                  <%= val if filter[:type] == 'formats' %>
                </label>
              </div>
            <% end %>
          </div>
        <%= '</div>'.html_safe if filter[:type] == 'formats' %>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
